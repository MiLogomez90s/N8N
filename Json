{"nodes":[{"parameters":{"updates":["message"]},"id":"1","name":"Telegram Trigger","type":"n8n-nodes-base.telegramTrigger","typeVersion":1,"position":[200,300],"credentials":{"telegramApi":{"id":"myTelegramCredential","name":"Telegram Account"}}},{"parameters":{"conditions":{"string":[{"value1":"={{$json.message.voice}}","operation":"isNotEmpty"}]}},"id":"2","name":"IF Voice or Text","type":"n8n-nodes-base.if","typeVersion":1,"position":[400,300]},{"parameters":{"resource":"audio","operation":"transcribe","fileUrl":"={{$json.message.voice.file_url}}","model":"whisper-1"},"id":"3","name":"Transcript OpenAI","type":"n8n-nodes-base.openAi","typeVersion":3,"position":[600,200],"credentials":{"openAiApi":{"id":"myOpenAICredential","name":"OpenAI API"}}},{"parameters":{"query":"SELECT history FROM chat_memory WHERE user_id = {{$json.message.from.id}} ORDER BY created_at DESC LIMIT 5;"},"id":"4","name":"Get Memory (Supabase)","type":"n8n-nodes-base.postgres","typeVersion":2,"position":[800,300],"credentials":{"postgres":{"id":"mySupabaseCredential","name":"Supabase"}}},{"parameters":{"functionCode":"const memory = items[0].json[0]?.history || \"\";\nconst input = $json.text || $json.message.text;\nreturn [{ json: { prompt: `Context:\n${memory}\n\nUser: ${input}` } }];"},"id":"5","name":"Assemble RAG Prompt","type":"n8n-nodes-base.function","typeVersion":1,"position":[1000,300]},{"parameters":{"resource":"chat","model":"gpt-3.5-turbo","messages":[{"role":"user","content":"={{$json.prompt}}"}]},"id":"6","name":"OpenAI Chat","type":"n8n-nodes-base.openAi","typeVersion":3,"position":[1200,300],"credentials":{"openAiApi":{"id":"myOpenAICredential","name":"OpenAI API"}}},{"parameters":{"query":"INSERT INTO chat_memory (user_id, history, created_at) VALUES ({{$json.message.from.id}}, {{$json.prompt}}, NOW());"},"id":"7","name":"Store Memory (Supabase)","type":"n8n-nodes-base.postgres","typeVersion":2,"position":[1400,400],"credentials":{"postgres":{"id":"mySupabaseCredential","name":"Supabase"}}},{"parameters":{"chatId":"={{$json.message.chat.id}}","text":"={{$json.choices[0].message.content}}"},"id":"8","name":"Send Telegram Reply","type":"n8n-nodes-base.telegram","typeVersion":1,"position":[1400,200],"credentials":{"telegramApi":{"id":"myTelegramCredential","name":"Telegram Account"}}}],"connections":{"Telegram Trigger":{"main":[["IF Voice or Text"]]},"IF Voice or Text":{"main":[["Transcript OpenAI"],["Get Memory (Supabase)"]]},"Transcript OpenAI":{"main":[["Get Memory (Supabase)"]]},"Get Memory (Supabase)":{"main":[["Assemble RAG Prompt"]]},"Assemble RAG Prompt":{"main":[["OpenAI Chat"]]},"OpenAI Chat":{"main":[["Send Telegram Reply"],["Store Memory (Supabase)"]]}},"name":"Telegram RAG Agent","settings":{},"tags":[]}
